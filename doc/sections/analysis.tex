

\chapter{Systemanalyse}
\section{Systemkontextdiagramm}



\begin{figure}[H]
	\begin{tikzpicture}[node distance=5]
		\node [draw, rectangle, drop shadow, fill=white] (F) {Fahrzeug};
		\node [draw, circle, drop shadow, fill=white, text width=3cm, align=center] (C) [below right=of F] {MEC-Server};
		\node [draw, rectangle, drop shadow, fill=white] (S) [below right=of C] {Sensor};
		\node [draw, rectangle, drop shadow, fill=white] (L) [above right=of C] {Client};
%		\node [draw, rectangle, drop shadow, fill=white] (A) [above right=of C] {Fusions-Algorithmus};
		
		\node (ctrl1) [above=of S] {};
		\node (ctrl2) [above right=of C] {};
		\node (ctrl3) [right=of C] {};
		\node (ctrl4) [below=of F] {};
		\node (ctrl5) [left=of C] {};
		\node (ctrl6) [below=of ctrl5] {};
		
		%
		% Fahrzeug -> MEC-Server
		%
		\path[draw, -{Latex[scale=2.0]}, dashed] (F)
				edge [bend right] node [fill=white] {deabonnieren} (C)
				edge [bend left]  node [fill=white] {abonnieren} (C);
				
		%
		% MEC-Server -> Fahrzeug
		%
		\path[draw, -{Latex[scale=2.0]}] (C)
				edge node [fill=white] {EnvironmentFrame} (F)
				.. controls (ctrl4) and (ctrl5) ..  node [fill=white] {Sektoren} (F);
				
		%
		% MEC-Server -> Algorithmus
		%
%		\path[draw, -{Latex[scale=2.0]}] (C)
%				edge [bend right] node [fill=white] {SensorFrame} (A);
		
		%
		% Algorithmus -> MEC-Server
		%
%		\path[draw, -{Latex[scale=2.0]}] (A)
%				edge [bend right] node [fill=white] {EnvironmentFrame} (C);
		
		%
		% Sensor -> MEC-Server
		%		
%		\path[draw, -{Latex[scale=2.0]}, dashed] (S);
			
		\path[draw, -{Latex[scale=2.0]}] (S)
			edge node [fill=white] {Sensor(Idle)Frame} (C);
				
		%
		% MEC-Server -> Sensor
		%
		\path[draw, -{Latex[scale=2.0]}, dashed] (C)
			edge [bend left]  node [fill=white] {abonnieren} (S)
			edge [bend right] node [fill=white] {deabonnieren} (S);
			
		%
		% Client -> MEC-Sensor
		%
		\path[draw, -{Latex[scale=2.0]}, dashed] (L)
			edge [bend right] node [fill=white] {Als Fahrzeug registrieren} (C)
			edge [bend left]  node [fill=white] {Als Sensor registrieren} (C);
				
				
		
		\path[draw, -{Latex[scale=2.0]}] (4, -8) -- (.5, -8) node [pos=.5, above] {Datenfluss};
		\path[draw, -{Latex[scale=2.0]}, dashed] (4, -9) -- (.5, -9) node [pos=.5, above] {Kontrollfluss};
			
	\end{tikzpicture}
	\centering
	\label{system_context}
	\caption{Systemkontextdiagramm}
\end{figure}
\cite[502]{goll2012methoden}

\section{Use Case Diagramme}
\todo{was wirklich umgesetzt sein wird}
\begin{figure}[H]
	\begin{tikzpicture}[node distance=5]
		\begin{umlsystem}{MEC-Server}
			\umlusecase[y=2,name=u1]{Als Fahrzeug registrieren}
			\umlusecase[y=0,name=u2]{Als Sensor registrieren}
		\end{umlsystem}
		\umlactor[x=-5.5,y=1]{Client}
		\umlassoc{Client}{u1}
		\umlassoc{Client}{u2}
	\end{tikzpicture}
	\centering
	\caption{Use Case Diagramm für den MEC-Server}
	\label{use_case:server_clients}
\end{figure}

\todo{Use-Case Beschreibung für \autoref{use_case:server_clients}}

\begin{figure}[H]
	\begin{tikzpicture}[node distance=5]
		\begin{umlsystem}{MEC-Server}
%			\umlusecase[y=4,name=u0]{Verbindung aufbauen}
			\umlusecase[y=2,name=u1]{abonnieren}
			\umlusecase[y=0,name=u2]{deabonnieren}
			\umlusecase[y=-2,name=u3]{SensorFrame zusenden}
			\umlusecase[y=-4,name=u4]{SensorIdleFrame zusenden}
%			\umlusecase[y=-4,name=u4]{Umfeldmodel übergeben}
		\end{umlsystem}
		\umlactor[x=-5.5,y=1]{Fahrzeug}
%		\umlactor[x=-6,y=-4]{Fusions-Algorithmus}
		\umlactor[x=5.5,y=-3]{Sensor}
%		\umlassoc{Fahrzeug}{u0}
		\umlassoc{Fahrzeug}{u1}
		\umlassoc{Fahrzeug}{u2}
%		\umlassoc{Sensor}{u0}
%		\umlassoc{Sensor}{u1}
		\umlassoc{Sensor}{u3}
		\umlassoc{Sensor}{u4}
%		\umlassoc{Fusions-Algorithmus}{u4}
	\end{tikzpicture}
	\centering
	\caption{Use Case Diagramm für den MEC-Server}
	\label{use_case:car}
\end{figure}

\todo{Use-Case Beschreibung für \autoref{use_case:car}}

\begin{figure}[H]
	\begin{tikzpicture}[node distance=5]
		\begin{umlsystem}{Sensor}
			\umlusecase[y=0,name=u1]{deabonnieren}
			\umlusecase[y=2,name=u2]{abonnieren}
		\end{umlsystem} 
		\umlactor[x=-4.5,y=1]{MEC-Server}
		\umlassoc{MEC-Server}{u1}
		\umlassoc{MEC-Server}{u2} 
	\end{tikzpicture}
	\centering
	\caption{Use Case Diagramm des MEC-Servers gegenüber dem Sensor}
	\label{use_case:server_sensor}
\end{figure}

\todo{Use-Case Beschreibung für \autoref{use_case:server_sensor}}

\begin{figure}[H]
	\begin{tikzpicture}[node distance=5]
		\begin{umlsystem}{Fahrzeug}
			\umlusecase[y=0,name=u1]{EnvironmentFrame zusenden}
			\umlusecase[y=2,name=u2]{Sektoren zusenden}
		\end{umlsystem} 
		\umlactor[x=-6,y=1]{MEC-Server}
		\umlassoc{MEC-Server}{u1}
		\umlassoc{MEC-Server}{u2}
	\end{tikzpicture}
	\centering
	\caption{Use Case Diagramm des MEC-Servers gegenüber dem Sensor}
	\label{use_case:server_vehicle}
\end{figure}

\todo{Use-Case Beschreibung für \autoref{use_case:server_vehicle}}

%\begin{figure}[H]
%	\begin{tikzpicture}[node distance=5]
%		\begin{umlsystem}{Fusions-Algorithmus}
%			\umlusecase[y=0,name=u1]{Sensordaten übergeben}
%		\end{umlsystem} 
%		\umlactor[x=-5,y=0]{MEC-Server}
%		\umlassoc{MEC-Server}{u1}
%	\end{tikzpicture}
%	\centering
%	\label{use_case:server_algorithmus}
%	\caption{Use Case Diagramm des MEC-Servers gegenüber dem Fusions-Algorithmus}
%\end{figure}


\newpage
\section{Nachrichten}


\begin{wrapfigure}{R}[-1.5em]{.5\textwidth}
	\centering
	\begin{bytefield}[bitwidth=.45em,bitheight=.7em]{32}
		\bitheader{0,31} \\
		
		\begin{rightwordgroup}{Kopf}
			\wordbox{4}{ASN.1 Nachrichtenlänge \textbf{$n$}} \\
			\wordbox{4}{ASN.1 Nachrichtentyp}
		\end{rightwordgroup} \\
		
		\begin{rightwordgroup}{Länge in\\\textbf{$n$} Bytes}
			\wordbox[lrt]{8}{ASN.1 Nachricht} \\
			\skippedwords \\
			\wordbox[lrb]{2}{}
		\end{rightwordgroup}
	\end{bytefield}
	\caption{ASN.1 Nachricht mit Kopfdaten}
	\label{message:structure}
\end{wrapfigure}

Eine ASN.1 Nachricht wird, wie in \autoref{message:structure} zu sehen, mit  vorangestellten Kopfdaten versendet.
Diese Kopfdaten enthalten die Länge der ASN.1 Nachricht und dessen Typ, der bei der Dekodierung beim Empfängers bekannt sein muss.
Die Nachrichtenlänge und der Nachrichtentyp werden als 32-Bit lange und vorzeichenlose Ganzzahlen übermittelt und entsprechen damit dem Datentyp \rustcinline{u32} in Rust.
Sie werden als \enquote{Big-Endian} auf dem Datenstrom dargestellt.

Die Nachrichtenlänge gibt die Länge der ASN.1 Nachricht in Bytes an.

Für den Nachrichtentyp sind nur die in \autoref{message:types} gelisteten Werte gültig und werden im Anschluss erklärt.

\begin{figure}[H]
	\centering
	\begin{tabular}{r|l|l}
		Typ & Nachricht & Aus Sichtweise des Servers \\
		\hline
		0 & \enquote{Nicht definiert} & -- \\
		1 & ClientRegistration & eingehend \\
		2 & SensorFrame & eingehend \\
		3 & EnvironmentFrame & ausgehend \\
		4 & UpdateSubscription & bidirektional \\
		5 & InitMessage & ausgehend \\
		6 & RoadClearanceFrame & ausgehend \\
		7 & SensorIdleFrame & eingehend \\
		8 & UpdateStatus & \todo{eingehend} \\
	\end{tabular}
	\caption{Gültige ASN.1 Nachrichtentypen}
	\label{message:types}
\end{figure}

\subsection{ClientRegistration}
\label{msg:client_registration}

\todo{Woher kommt die? Anforderungen? Use Cases? Kontextdiagramm?}

Die ClientRegistration-Nachricht sendet der Client nach dem Verbindungsaufbau dem Server zu, um mitzuteilen, ob es sich um einen Sensor oder ein Fahrzeug handelt.

\subsection{SensorFrame}
\label{msg:sensor_frame}

Die SensorFrame-Nachricht wird vom Sensor an den Server versendet und beschreibt Objekte, die der Sensor erkannt hat.

\subsection{EnvironmentFrame}
\label{msg:environment_frame}

Die EnvironmentFrame-Nachricht wird vom Server an das Fahrzeug versendet und enthält das Ergebnis des Fusions-Algorithmus.

\subsection{UpdateSubscription}

Die UpdateSubscription-Nachricht wird vom Server an den Sensor oder vom Fahrzeug an den Server gesendet.
Der Sensor versendet bei einer Anmeldung erkannte Objekte (siehe \autoref{msg:sensor_frame}), während der Server dem Fahrzeug die Ergebnisse aus dem Fusions-Algorithmus (siehe \autoref{msg:environment_frame}) zusendet.
Bei einer Abmeldung wird das Versenden der Nachrichten eingestellt.

\subsection{InitMessage}

Die InitMessage-Nachricht wird vom Server, nach einer Fahrzeuganmeldung, an das Fahrzeug gesendet und beinhaltet Koordinaten über die Sektoren, die die Sensoren beobachten.

\subsection{RoadClearanceFrame}

Die RoadClearanceFrame-Nachricht wird vom Server an das Fahrzeug versendet und kann Verkehrs-, Wetter- und andere Informationen über die Sektoren enthalten.

\subsection{SensorIdleFrame}

Die SensorIdleFrame-Nachricht wird vom Sensor in regelmäßigen Zeitintervallen an den Server versendet, wenn der Sensor nicht abonniert ist.
Die Anwesenheit des Sensors wird somit festgestellt.

\subsection{UpdateStatus}

\todo{huh?}


%\begin{figure}[H]
%	\centering
%	\begin{bytefield}[bitwidth=.25em,bitheight=2em]{128}
%		\bitheader{0,32,64} \\
%		
%		\bitbox{32}{Länge $n$}
%		\bitbox{32}{Nachricht Id}
%		\bitbox{64}{ASN.1 Nachricht der Länge $n$}
%		%		\skippedbits
%		%		\bitbox[tbr]{32}{}
%	\end{bytefield}
%	\caption{Aufbau eines WebSocket-Frames \cite[28]{ieft:websockets}}
%	\label{figure:websockets:frame}
%\end{figure}
%\todo{alternativ:}
%\begin{figure}[H]
%	\centering
%	\begin{tikzpicture}
%		\draw[green!2,fill] (0,0) rectangle (2,-3);
%		\draw[red!6,fill] (2,0) rectangle (6,-3);
%		\draw[green!8,fill] (6,0) rectangle (14,-3);
%		\draw[red!2,fill] (14,0) rectangle (16,-3);
%		
%		\draw[gray!40, very thin] (0,0) -- (16,0);
%		\draw[gray!40, very thin] (0,-2) -- (16,-2);
%		\draw (2,0) -- (14,0);
%		\draw (2,-2) -- (14,-2);
%		\draw[gray!40, very thin] (2,-3) -- (2,0.2);
%		\draw (2,0.5) node {0};
%		\draw (3,-1) node {Länge $n$};
%%		\draw (3,-1.7) node {\rustcinline{u32}};
%		\draw[gray!40, very thin] (4,-2) -- (4,0.2);
%		\draw (4,0.5) node {32};
%		\draw (5,-1) node {Id};
%%		\draw (5,-1.7) node {\rustcinline{u32}};
%		\draw[gray!40, very thin] (6,-3) -- (6,0.2);
%		\draw (6,0.5) node {64};
%		\draw[gray!40, very thin] (14,-3) -- (14,0.2);
%		\draw (14,0.5) node {$64 + n$};
%		\draw (10,-1) node {ASN.1 Nachricht};
%		
%		\draw (4,-2.5) node {Kopf};
%		\draw (10,-2.5) node {Korpus};
%	\end{tikzpicture}
%	\label{message:structure_alt}
%	\caption{Aufbau einer Nachricht auf dem Datenstrom}
%\end{figure}


\section{Schnittstellenanalyse}


\begin{figure}[H]
	\begin{tikzpicture}
		\begin{umlseqdiag} 
			\umlactor[x=0,no ddots]{Sensor}
			\umlactor[x=11,no ddots]{MEC-Server}
			\begin{umlcall}[dt=4, op={ClientRegistration\{type = sensor, ..\}}, type=asynchron]{Sensor}{MEC-Server}
				\begin{umlcall}[dt=5, op={UpdateSubscription\{subscription-status = unsubscribe, ..\}}, type=asynchron]{MEC-Server}{Sensor}
				\end{umlcall}
			\end{umlcall}
			
			\begin{umlfragment}[type=loop]
				\begin{umlcall}[dt=7, op={SensorIdleFrame\{..\}}, type=asynchron]{Sensor}{MEC-Server}
				\end{umlcall}
			\end{umlfragment}
			
			\begin{umlcall}[dt=7, op={UpdateSubscription\{subscription-status = subscribe, ..\}}, type=asynchron]{MEC-Server}{Sensor}
			\end{umlcall}
			
			\begin{umlfragment}[type=loop]
				\begin{umlcall}[dt=7, op={SensorFrame\{..\}}, type=asynchron]{Sensor}{MEC-Server}
				\end{umlcall}
			\end{umlfragment}
			
			\begin{umlcall}[dt=7, op={UpdateSubscription\{subscription-status = unsubscribe, ..\}}, type=asynchron]{MEC-Server}{Sensor}
			\end{umlcall}
			
			\begin{umlfragment}[type=loop]
				\begin{umlcall}[dt=7, op={SensorIdleFrame\{..\}}, type=asynchron]{Sensor}{MEC-Server}
				\end{umlcall}
			\end{umlfragment}
		\end{umlseqdiag}
	\end{tikzpicture}
	\centering
	\label{seq_dia:sensor}
	\caption{Kommunikation zwischen Sensor und MEC-Server}
\end{figure}


\begin{figure}[H]
	\begin{tikzpicture}
		\begin{umlseqdiag} 
			\umlactor[x=0,no ddots]{Fahrzeug}
			\umlactor[x=11,no ddots]{MEC-Server}
			\begin{umlcall}[dt=4, op={ClientRegistration\{type = vehicle, ..\}}, type=asynchron]{Fahrzeug}{MEC-Server}
				\begin{umlcall}[dt=5, op={InitMessage\{..\}}, type=asynchron]{MEC-Server}{Fahrzeug}
				\end{umlcall}
			\end{umlcall}
			\begin{umlcall}[dt=5, op={UpdateSubscription\{subscription-status = subscribe, ..\}}, type=asynchron]{Fahrzeug}{MEC-Server}
			\end{umlcall}
			\begin{umlfragment}[type=loop] 
				\begin{umlcall}[dt=8, op={EnvironmentFrame\{..\}}, type=asynchron]{MEC-Server}{Fahrzeug}
				\end{umlcall}
			\end{umlfragment}
			
			\begin{umlcall}[dt=6, op={UpdateSubscription\{subscription-status = unsubscribe, ..\}}, type=asynchron]{Fahrzeug}{MEC-Server}
			\end{umlcall}
		\end{umlseqdiag}
	\end{tikzpicture}
	\centering
	\label{seq_dia:vehicle}
	\caption{Kommunikation zwischen Fahrzeug und MEC-Server}
\end{figure}


\begin{figure}[H]
	\begin{tikzpicture}
		\begin{umlseqdiag} 
			\umlactor[x=0,no ddots]{Sensor}
			\umlactor[x=6,no ddots]{MEC-Server}
			\umlactor[x=12,no ddots]{Fahrzeug}
			
			
			\begin{umlcall}[dt=5, op={register}, type=asynchron]{Sensor}{MEC-Server}
				\begin{umlcall}[dt=5, op={unsubscribe}, type=asynchron]{MEC-Server}{Sensor}
				\end{umlcall}
			\end{umlcall}
			
			
			\begin{umlfragment}[type=loop] 
				\begin{umlcall}[dt=6,op={SensorIdleFrame}, type=asynchron]{Sensor}{MEC-Server}
				\end{umlcall}
			\end{umlfragment}
			
			\begin{umlcall}[dt=28,op={register}, type=asynchron]{Fahrzeug}{MEC-Server}
				\begin{umlcall}[dt=5,op={InitMessage}, type=asynchron]{MEC-Server}{Fahrzeug}
				\end{umlcall}
				\begin{umlcall}[dt=0,op={subscribe}, type=asynchron]{MEC-Server}{Sensor}
				\end{umlcall}
			\end{umlcall}
			
			\begin{umlfragment}[type=loop] 
				\begin{umlcall}[dt=8, op={SensorFrame}, type=asynchron]{Sensor}{MEC-Server}
				\end{umlcall}
			\end{umlfragment}
			
			\begin{umlcall}[dt=14,op={subscribe}, type=asynchron]{Fahrzeug}{MEC-Server}
			\end{umlcall}
			
			\begin{umlfragment}[type=loop] 
				\begin{umlcall}[dt=15,op={SensorFrame}, type=asynchron]{Sensor}{MEC-Server}
					\begin{umlcall}[dt=2, op={EnvironmentFrame}, type=asynchron]{MEC-Server}{Fahrzeug}
					\end{umlcall}
				\end{umlcall}
			\end{umlfragment}
			
			\begin{umlcall}[dt=8,op={unsubscribe}, type=asynchron]{Fahrzeug}{MEC-Server}
			\end{umlcall}
			
			
			\begin{umlfragment}[type=loop] 
				\begin{umlcall}[dt=15, op={SensorFrame}, type=asynchron]{Sensor}{MEC-Server}
				\end{umlcall}
			\end{umlfragment}
			
			\umlsdnode[dt=11]{Fahrzeug}
			\draw[dashed] (-2,-16.5) -- (14,-16.5);
			\draw (9.225,-16.25) node {Fahrzeug trennt die Verbindung};

			\begin{umlcall}[dt=8,op={unsubscribe}, type=asynchron]{MEC-Server}{Sensor}
			\end{umlcall}
			
			\begin{umlfragment}[type=loop] 
				\begin{umlcall}[dt=6,op={SensorIdleFrame}, type=asynchron]{Sensor}{MEC-Server}
				\end{umlcall}
			\end{umlfragment}
		\end{umlseqdiag}
	\end{tikzpicture}
	\centering
	\label{seq_dia:both}
	\caption{Interaktion des MEC-Servers mit einem Fahrzeug und einem Sensor}
\end{figure}